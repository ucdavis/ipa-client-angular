<nav year="{{ year }}" term-short-code="{{ termShortCode }}" workgroup-id="{{ workgroupId }}"></nav>

<ipa-header page-title="Scheduling"></ipa-header>

<div class="wrap">
	<div class="main-content">

		<div class="activity-page-header">
			<div class="activity-filters">
				<div class="activity-filter-menu">
					<div class="btn-group pull-left">
						<div class="btn" ng-click="toggleCheckAll()">
							<i ng-show="view.state.uiState.checkedSectionGroupIds.length" class="sg-checkbox fa fa-check-square-o"></i>
							<i ng-hide="view.state.uiState.checkedSectionGroupIds.length" class="sg-checkbox fa fa-square-o"></i>
							<span style="margin-left: 0.3em;">
								{{ view.state.uiState.checkedSectionGroupIds.length ? "Unselect" : "Select" }} all
							</span>
						</div>
					</div>
					<div class="btn-group pull-right">
						<button class="btn btn-white btn-block dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true"
							aria-expanded="false">
							Filters <span class="caret"></span>
						</button>
						<div class="dropdown-menu" style="width: 400px; padding: 0;">
							<div class="filters-container" stop-event="click">
								<div class="tags-filter">
									<h3>Tags</h3>
									<ul>
										<li ng-repeat="tagId in view.state.tags.ids track by $index" ng-click="toggleTagFilter(tagId)">
											<div class="checkbox checkbox-replace color-primary neon-cb-replacement" ng-class="{ 'checked': view.state.filters.enabledTagIds.indexOf(tagId) >= 0 }">
												<label class="cb-wrapper filter-checkbox" ng-style="{ 'border-color': view.state.tags.list[tagId].color }">
													<div class="checked" ng-style="{ 'background': view.state.tags.list[tagId].color }"></div>
												</label>
												<label class="filter-label" ng-bind="view.state.tags.list[tagId].name"></label>
											</div>
										</li>
									</ul>
								</div>
								<div class="instructors-filter">
									<h3>Instructors</h3>
									<ul>
										<li ng-repeat="instructorId in view.state.instructors.ids track by instructorId"
											ng-click="toggleInstructorFilter(instructorId)">
											<div class="checkbox checkbox-replace color-primary neon-cb-replacement" ng-class="{ 'checked': view.state.filters.enabledInstructorIds.indexOf(instructorId) >= 0 }">
												<label class="cb-wrapper filter-checkbox">
													<div class="checked"></div>
												</label>
												<label class="filter-label">{{ view.state.instructors.list[instructorId].fullName }}</label>
											</div>
										</li>
									</ul>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="calendar-filter-header">
					<div class="activity-filter-tokens text-center">
						<div class="label label-selected-section-group" ng-repeat="tagId in view.state.filters.enabledTagIds track by $index">
							{{ view.state.tags.list[tagId].name }}
							<i class="glyphicon glyphicon-remove selected-section-group-remove clickable hoverable" ng-click="toggleTagFilter(tagId)"></i>
						</div>
						<div class="label label-selected-section-group" ng-repeat="locationId in view.state.filters.enabledLocationIds track by $index">
							{{ view.state.locations.list[locationId].description }}
							<i class="glyphicon glyphicon-remove selected-section-group-remove clickable hoverable" ng-click="toggleLocationFilter(locationId)"></i>
						</div>
						<div class="label label-selected-section-group" ng-repeat="instructorId in view.state.filters.enabledInstructorIds track by $index">
							{{ view.state.instructors.list[instructorId].fullName }}
							<i class="glyphicon glyphicon-remove selected-section-group-remove clickable hoverable" ng-click="toggleInstructorFilter(instructorId)"></i>
						</div>
						<div class="label label-selected-section-group" ng-repeat="sectionGroupId in view.state.uiState.checkedSectionGroupIds track by $index">
							{{ view.state.courses.list[view.state.sectionGroups.list[sectionGroupId].courseId].subjectCode }}
							{{ view.state.courses.list[view.state.sectionGroups.list[sectionGroupId].courseId].courseNumber }} -
							{{ view.state.courses.list[view.state.sectionGroups.list[sectionGroupId].courseId].sequencePattern }}
							<i class="glyphicon glyphicon-remove selected-section-group-remove clickable hoverable" ng-click="toggleCheckedSectionGroup(sectionGroupId, $event)"></i>
						</div>
					</div>
					<div class="calendar-filter-menu">
						<div class="btn-group pull-right">
							<button class="btn btn-white btn-block dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true"
								aria-expanded="false">
								Filters <span class="caret"></span>
							</button>
							<div class="dropdown-menu" style="width: 400px; padding: 0;">
								<div class="filters-container" stop-event="click">
									<div class="days-filter">
										<h3>Days</h3>
										<ul>
											<li ng-repeat="day in ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'] track by $index"
												ng-click="toggleCalendarDay($index)">
												<div class="checkbox checkbox-replace color-primary neon-cb-replacement" ng-class="{ 'checked': view.state.filters.hiddenDays.indexOf($index) < 0 }">
													<label class="cb-wrapper filter-checkbox">
														<div class="checked"></div>
													</label>
													<label class="filter-label">{{ day }}</label>
												</div>
											</li>
										</ul>
									</div>
									<div class="locations-filter">
										<h3>Locations</h3>
										<ul>
											<li ng-repeat="locationId in view.state.locations.ids track by $index" ng-click="toggleLocationFilter(locationId)">
												<div class="checkbox checkbox-replace color-primary neon-cb-replacement" ng-class="{ 'checked': view.state.filters.enabledLocationIds.indexOf(locationId) >= 0 }">
													<label class="cb-wrapper filter-checkbox">
														<div class="checked"></div>
													</label>
													<label class="filter-label" ng-bind="view.state.locations.list[locationId].description"></label>
												</div>
											</li>
										</ul>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="section-group-container">
			<div class="section-group-list" ng-class="{ 'collapsed': view.state.uiState.selectedSectionGroupId }">
				<div ng-hide="view.state.sectionGroups.ids" class="loading-center">
					<spinner></spinner>
				</div>
				<ul ng-show="view.state.sectionGroups.ids">
					<li class="section-group-item" ng-repeat="sectionGroupId in view.state.sectionGroups.ids track by $index"
						ng-show="matchesFilters(view.state.sectionGroups.list[sectionGroupId])"
						ng-class="{ 'active': view.state.uiState.selectedSectionGroupId == sectionGroupId }"
						ng-click="setSelectedSectionGroup(sectionGroupId)">

						<div class="section-group-check" ng-if="view.state.uiState.selectedSectionGroupId != sectionGroupId"
							ng-click="toggleCheckedSectionGroup(sectionGroupId, $event)" stop-event="click">
							<i ng-show="view.state.uiState.checkedSectionGroupIds.indexOf(sectionGroupId) >= 0" class="sg-checkbox fa fa-check-square-o"></i>
							<i ng-hide="view.state.uiState.checkedSectionGroupIds.indexOf(sectionGroupId) >= 0" class="sg-checkbox fa fa-square-o"></i>
						</div>
						<div class="section-group-check" ng-if="view.state.uiState.selectedSectionGroupId == sectionGroupId">
						</div>
						<div class="section-group-description">
							<span>
								{{ view.state.courses.list[view.state.sectionGroups.list[sectionGroupId].courseId].subjectCode }}
								{{ view.state.courses.list[view.state.sectionGroups.list[sectionGroupId].courseId].courseNumber }}
								- {{ view.state.courses.list[view.state.sectionGroups.list[sectionGroupId].courseId].sequencePattern }}
							</span>
							<br />
							<small class="text-muted">{{ view.state.courses.list[view.state.sectionGroups.list[sectionGroupId].courseId].title }}</small>
							<br />
							<small class="text-muted">
								Units: {{ view.state.courses.list[view.state.sectionGroups.list[sectionGroupId].courseId].unitsLow }}

								<!-- TODO: Display enrollment and total seats (Involves modifying payload to include all sections) -->

								<div ng-if="view.state.sectionGroups.list[sectionGroupId].instructorIds.length">
									instructor{{ view.state.sectionGroups.list[sectionGroupId].instructorIds.length > 1 ? 's':'' }}:
									<div class="label label-default" style="padding: 3px; margin-left: 3px;"
										ng-repeat="instructorId in view.state.sectionGroups.list[sectionGroupId].instructorIds track by instructorId">
										{{ view.state.instructors.list[instructorId] | lastSpaceInitial }}{{ $last ? '':', '}}
									</div>
								</div>

								<div ng-if="view.state.sectionGroups.list[sectionGroupId].showTheStaff">
									instructor:
									<div class="label label-default instructor-label">
										The Staff
									</div>
								</div>

								<div ng-if="view.state.courses.list[view.state.sectionGroups.list[sectionGroupId].courseId].tagIds.length">
									Tags:
									<div class="label" style="padding: 3px; margin-left: 3px;"
										ng-repeat="tagId in view.state.courses.list[view.state.sectionGroups.list[sectionGroupId].courseId].tagIds track by $index"
										ng-style="{ 'background-color': view.state.tags.list[tagId].color || '#333', 'color': view.state.tags.list[tagId].getTextColor() }">
										{{ view.state.tags.list[tagId].name }}
									</div>
								</div>
							</small>
						</div>
					</li>
				</ul>
			</div>
			<div class="activity-container" ng-class="{ 'collapsed': !view.state.uiState.selectedSectionGroupId }">
				<div class="activity-list" ng-class="{ 'collapsed': view.state.uiState.selectedActivityId && !isLocked() }">
					<div ng-hide="view.state.sectionGroups.list[view.state.uiState.selectedSectionGroupId].sectionIds" class="loading-center">
						<spinner></spinner>
					</div>
					<div ng-show="view.state.sectionGroups.list[view.state.uiState.selectedSectionGroupId].sectionIds">

						<p class="activity-list-header">
							{{ view.state.courses.list[view.state.uiState.selectedCourseId].subjectCode }} {{ view.state.courses.list[view.state.uiState.selectedCourseId].courseNumber
							}} - {{ view.state.courses.list[view.state.uiState.selectedCourseId].sequencePattern }}
						</p>
						<p ng-hide="view.state.sectionGroups.list[view.state.uiState.selectedSectionGroupId].sectionIds.length"
							class="text-center text-muted">
							No Sections
						</p>
						<div ng-show="view.state.sectionGroups.list[view.state.uiState.selectedSectionGroupId].sectionIds.length">
							<!-- All Sections header (or the first section if sequence pattern is numeric) -->
							<div class="section-pattern" ng-show="view.state.courses.list[view.state.uiState.selectedCourseId].isSeries()">All Sections</div>
							<div class="section-pattern" ng-hide="view.state.courses.list[view.state.uiState.selectedCourseId].isSeries()">
								Section {{ view.state.courses.list[view.state.uiState.selectedCourseId].sequencePattern }}
							</div>
							<!-- List of shared activities -->
							<ul ng-repeat="sharedActivityId in view.state.sectionGroups.list[view.state.uiState.selectedSectionGroupId].sharedActivityIds track by $index"
								class="activity-group" ng-init="sharedActivity = view.state.activities.list[sharedActivityId];">
								<li ng-show="activityMatchesFilters(sharedActivityId)" 
									class="activity-item clickable" ng-class="{ 'active': view.state.uiState.selectedActivityId == sharedActivityId }"
									ng-click="setSelectedActivity(sharedActivityId)">
									<span>{{ sharedActivity.getCodeDescription() }}</span>
									<i class="entypo-minus-squared pull-right delete-activity clickable" ng-if="!isLocked()" uib-tooltip="Remove shared {{ sharedActivity.getCodeDescription() }}"
										tooltip-append-to-body="true" confirm-button="removeActivity(sharedActivity)" message="Are you sure you want to remove this {{ sharedActivity.getCodeDescription() }}"
										yes="Delete" no="Cancel" placement="right"></i>
								</li>

								<!-- muted version when shared activity doesn't match filter -->
								<li ng-show="activityMatchesFilters(sharedActivityId) == false"
								class="activity-item muted-activity"
										uib-tooltip="Activity does not match filters"
										tooltip-append-to-body="true">
									<span>{{ sharedActivity.getCodeDescription() }}</span>
								</li>
							</ul>

							<div ng-if="view.state.sectionGroups.list[view.state.uiState.selectedSectionGroupId].sectionIds.length > 0 && !isLocked()"
								class="add-activity-btn clickable hoverable" uib-popover-template="'addSharedActivityList.html'"
								popover-placement="bottom-left" popover-append-to-body="true" popover-class="add-activity-popover"
								popover-trigger="outsideClick" popover-is-open="view.addSharedActivityPopoverIsOpen[view.state.uiState.selectedSectionGroupId]">
								<i class="entypo-plus-squared"></i> Add Activity
							</div>
							<!-- List of sections if the sectionGroup is a series -->
							<ul ng-if="view.state.courses.list[view.state.uiState.selectedCourseId].isSeries()">
								<li class="section-item"
										ng-repeat="sectionId in view.state.sectionGroups.list[view.state.uiState.selectedSectionGroupId].sectionIds"
										ng-init="section = view.state.sections.list[sectionId];">
									<div class="section-pattern">Section {{ section.sequenceNumber }}</div>
									<ul class="activity-group" ng-repeat="activityId in section.activityIds track by $index" ng-init="activity = view.state.activities.list[activityId];">
										<li ng-show="activityMatchesFilters(activityId)"
												class="activity-item clickable"
												ng-class="{ 'active': view.state.uiState.selectedActivityId == activityId }"
											ng-click="setSelectedActivity(activityId)">
											<span>{{ activity.getCodeDescription() }}</span>
											<i class="entypo-minus-squared pull-right delete-activity clickable" ng-if="!isLocked()" uib-tooltip="Remove {{ activity.getCodeDescription() }}"
												tooltip-append-to-body="true" confirm-button="removeActivity(activity)" message="Are you sure you want to remove this {{ activity.getCodeDescription() }}"
												yes="Delete" no="Cancel" placement="right"></i>
											<i class="glyphicon glyphicon-warning-sign pull-right text-warning" uib-tooltip="Activity no longer matches standard pattern"
												ng-show="activityId == view.state.uiState.selectedActivityId && view.state.uiState.selectedActivity.hasWarning"></i>
										</li>

										<!-- muted version when activity doesn't match filter -->
										<li ng-show="activityMatchesFilters(activityId) == false"
										class="activity-item muted-activity"
												uib-tooltip="Activity does not match filters"
												tooltip-append-to-body="true">
											<span>{{ activity.getCodeDescription() }}</span>
										</li>
									</ul>
									<div class="add-activity-btn clickable hoverable" ng-if="!isLocked()" uib-popover-template="'addActivityList.html'"
										popover-placement="bottom-left" popover-append-to-body="true" popover-class="add-activity-popover"
										popover-trigger="outsideClick" popover-is-open="view.addActivityPopoverIsOpen[sectionId]">
										<i class="entypo-plus-squared"></i> Add
									</div>
								</li>
							</ul>
						</div>
					</div>
				</div>
				<div class="activity-details" ng-class="{ 'collapsed': !view.state.uiState.selectedActivityId && !isLocked() }"
					ng-if="!isLocked()">
					<div ng-show="view.state.uiState.selectedActivityId">
						<p class="activity-details-header">
							{{ view.state.activities.list[view.state.uiState.selectedActivityId].getCodeDescription() }}
							<a ng-click="closeActivityDetails()" class="close"><i class="entypo-cancel"></i></a>
						</p>
						<form class="form-horizontal">
							<strong>Location</strong>
							<hr style="margin: 0 0 5px 0;" />
							<div class="form-group">
								<div class="col-sm-12 text-center">
									<uib-tabset active="view.state.activities.list[view.state.uiState.selectedActivityId].locationType" justified="true">
										<uib-tab index="'registrar'" heading="Registrar Provided" classes="location-tab" ng-click="setLocation(0)">

											{{ view.state.activities.list[view.state.uiState.selectedActivityId].bannerLocation || 'Not yet set in
											Banner' }}

										</uib-tab>
										<uib-tab index="'custom'" heading="Custom" classes="location-tab">

											<!-- Show the locations dropdown only if the current workgroup has at least a location set -->
											<div ng-if="view.state.locations.ids.length > 0">

												<div class="btn-group btn-group-justified">
													<div class="btn-group" uib-dropdown>
														<button type="button" class="btn btn-default dropdown-location" uib-dropdown-toggle>
															{{ view.state.locations.list[view.state.activities.list[view.state.uiState.selectedActivityId].locationId].description || "Select Custom Location"}}
															<span class="caret pull-right"></span>
														</button>
														<ul class="dropdown-menu" uib-dropdown-menu role="menu" aria-labelledby="single-button">
															<li class="clickable" ng-repeat="locationId in view.state.locations.ids track by locationId" ng-class="{ 'active': view.state.activities.list[view.state.uiState.selectedActivityId].locationId == locationId }">
																<a ng-bind="view.state.locations.list[locationId].description" ng-click="setLocation(locationId)"></a>
															</li>
														</ul>
													</div>
												</div>

											</div>

											<!-- IF the workgroup does not have any custom locations -->
											<div ng-if="view.state.locations.ids.length === 0">
												<small>No custom locations are available, <br />please add some in the workgroup configuration</small>
											</div>

										</uib-tab>
									</uib-tabset>
								</div>
							</div>
							<strong>Time</strong>
							<hr style="margin: 0 0 5px 0;" />
							<div class="form-group">
								<div class="col-sm-12">
									<div class="radio">
										<label>
											<input type="radio" name="buildingRadios" ng-value="true" ng-model="view.state.activities.list[view.state.uiState.selectedActivityId].isStandardTimes">Standard times
										</label>
									</div>
									<!-- Standard times -->
									<div ng-show="view.state.activities.list[view.state.uiState.selectedActivityId].isStandardTimes">
										<fieldset>
											<div class="col-sm-4" style="padding: 0px;">
												<select size="4" class="form-control standard-time" ng-options="duration as (duration + ' min') for (duration,pattern) in standardPatterns"
													ng-model="view.state.activities.list[view.state.uiState.selectedActivityId].selectedDuration">
												</select>
											</div>
											<div class="control-group col-sm-3" style="padding: 0px 0px 0px 5px;">
												<select size="4" class="form-control standard-time" ng-options="dayIndicator as getWeekDays(dayIndicator)
												for dayIndicator in standardPatterns[view.state.activities.list[view.state.uiState.selectedActivityId].selectedDuration].dayIndicators"
													ng-model="view.state.activities.list[view.state.uiState.selectedActivityId].dayIndicator"
													ng-click="setDayPattern(dayIndicator)">
												</select>
											</div>
											<div class="control-group col-sm-5" style="padding: 0px 0px 0px 5px;">
												<select size="4" class="form-control standard-time">
													<option ng-repeat="time in standardPatterns[view.state.activities.list[view.state.uiState.selectedActivityId].selectedDuration].times"
													ng-selected="time.start === view.state.activities.list[view.state.uiState.selectedActivityId].startTime && time.end === view.state.activities.list[view.state.uiState.selectedActivityId].endTime"
													ng-click="setActivityStandardTime(time)">
														{{ getMeridianTime(time.start) }} - {{ getMeridianTime(time.end) }}
													</option>
												</select>
											</div>
										</fieldset>
									</div>

									<div class="radio">
										<label>
											<input type="radio" name="buildingRadios" ng-value="false" ng-model="view.state.activities.list[view.state.uiState.selectedActivityId].isStandardTimes">Non-standard times
										</label>
									</div>

									<!-- Non-standard times -->
									<div ng-hide="view.state.activities.list[view.state.uiState.selectedActivityId].isStandardTimes">
										<div class="form-group">
											<div class="input-group">
												<label class="col-sm-6 control-label" style="padding-right: 0;">
													Repeats every: &nbsp;
												</label>
												<div class="col-sm-5" style="padding-left: 0;">
													<div class="input-group input-group-sm">
														<input auto-input type="number" min="1" class="form-control" on-enter="saveActivity()" on-blur="saveActivity()"
															help-text-placement="top" ng-model="view.state.activities.list[view.state.uiState.selectedActivityId].frequency"
														/>
														<span class="input-group-addon">weeks</span>
													</div>
												</div>
											</div>
										</div>
										<div class="form-group">
											<div class="col-sm-offset-1 col-sm-10">
												<div class="btn-group btn-group-justified btn-group-xs">
													<div class="btn-group ng-scope" ng-repeat="day in days track by $index">
														<button ng-click="toggleActivityDay($index)" ng-class="{'active': view.state.activities.list[view.state.uiState.selectedActivityId].dayIndicator[$index] === '1'}"
															type="button" class="btn btn-default ng-binding">{{day}}</button>
													</div>
												</div>
											</div>
										</div>
										<div class="form-group">
											<div class="col-sm-offset-1 col-sm-5 text-center">
												<time-input time="view.state.activities.list[view.state.uiState.selectedActivityId].startTime" minute-step="5"
													on-change-delay="500" on-change="saveActivity()"></time-input>
											</div>
											<div class="col-sm-5 text-center">
												<time-input time="view.state.activities.list[view.state.uiState.selectedActivityId].endTime" minute-step="5"
													on-change-delay="500" on-change="saveActivity()"></time-input>
											</div>
										</div>
									</div>
								</div>
							</div>

						</form>

					</div>
				</div>
			</div>
			<div class="activity-calendar">
				<div ng-hide="view.state.sectionGroups.ids" class="loading-center">
					<spinner></spinner>
				</div>
				<term-calendar></term-calendar>
			</div>
		</div>

	</div>
</div>